name: ci

on:
  push:
  pull_request:

jobs:
  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      - run: cargo fmt --check

  clippy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            args: ""
          - name: blocking-rustls
            args: "--no-default-features --features blocking,rustls"
          - name: async-all
            args: >-
              --no-default-features
              --features async,rustls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: blocking-all
            args: >-
              --no-default-features
              --features blocking,rustls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: async-all-native-tls
            args: >-
              --no-default-features
              --features async,native-tls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: blocking-all-native-tls
            args: >-
              --no-default-features
              --features blocking,native-tls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: Install OpenSSL (native-tls)
        if: contains(matrix.name, 'native-tls')
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config
      - run: cargo clippy --all-targets ${{ matrix.args }} -- -D warnings

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            args: ""
          - name: blocking-rustls
            args: "--no-default-features --features blocking,rustls"
          - name: async-all
            args: >-
              --no-default-features
              --features async,rustls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: blocking-all
            args: >-
              --no-default-features
              --features blocking,rustls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: async-all-native-tls
            args: >-
              --no-default-features
              --features async,native-tls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
          - name: blocking-all-native-tls
            args: >-
              --no-default-features
              --features blocking,native-tls,multipart,checksums,credentials-profile,credentials-imds,credentials-sts,tracing,metrics
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@v2
      - name: Install OpenSSL (native-tls)
        if: contains(matrix.name, 'native-tls')
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config
      - run: cargo test ${{ matrix.args }}

  minio-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@v2
      - name: Install OpenSSL (native-tls)
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config
      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            -e MINIO_DOMAIN=localhost \
            minio/minio:latest server /data --console-address ":9001"
      - name: Wait for MinIO
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:9000/minio/health/ready > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "MinIO did not become ready in time" >&2
          exit 1
      - name: Async integration
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
        run: cargo test --test minio_async --features multipart
      - name: Async integration (native-tls)
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
        run: cargo test --test minio_async --no-default-features --features async,native-tls,multipart
      - name: Blocking integration
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
        run: cargo test --test minio_blocking --no-default-features --features blocking,rustls,multipart
      - name: Blocking integration (native-tls)
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: minioadmin
          AWS_SECRET_ACCESS_KEY: minioadmin
        run: cargo test --test minio_blocking --no-default-features --features blocking,native-tls,multipart
      - name: Stop MinIO
        if: always()
        run: docker rm -f minio || true

  rustfs-integration:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@v2
      - name: Install OpenSSL (native-tls)
        run: sudo apt-get update && sudo apt-get install -y libssl-dev pkg-config
      - name: Start RustFS
        run: |
          docker run -d --name rustfs \
            -p 9000:9000 -p 9001:9001 \
            -e RUSTFS_ACCESS_KEY=rustfsadmin \
            -e RUSTFS_SECRET_KEY=rustfsadmin \
            -e RUSTFS_SERVER_DOMAINS=localhost:9000 \
            rustfs/rustfs:latest
      - name: Wait for RustFS
        run: |
          for i in $(seq 1 60); do
            if curl -fsS http://127.0.0.1:9000/health > /dev/null; then
              exit 0
            fi
            sleep 1
          done
          echo "RustFS did not become ready in time" >&2
          exit 1
      - name: Async integration
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: rustfsadmin
          AWS_SECRET_ACCESS_KEY: rustfsadmin
        run: cargo test --test minio_async --features multipart
      - name: Async integration (native-tls)
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: rustfsadmin
          AWS_SECRET_ACCESS_KEY: rustfsadmin
        run: cargo test --test minio_async --no-default-features --features async,native-tls,multipart
      - name: Blocking integration
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: rustfsadmin
          AWS_SECRET_ACCESS_KEY: rustfsadmin
        run: cargo test --test minio_blocking --no-default-features --features blocking,rustls,multipart
      - name: Blocking integration (native-tls)
        env:
          S3_TEST_ENDPOINT: http://127.0.0.1:9000
          S3_TEST_REGION: us-east-1
          AWS_ACCESS_KEY_ID: rustfsadmin
          AWS_SECRET_ACCESS_KEY: rustfsadmin
        run: cargo test --test minio_blocking --no-default-features --features blocking,native-tls,multipart
      - name: Stop RustFS
        if: always()
        run: docker rm -f rustfs || true
